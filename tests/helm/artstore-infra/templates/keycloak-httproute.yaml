# HTTPRoute для Keycloak — внешний доступ через Envoy Gateway (Gateway API).
# Маршрутизирует трафик Keycloak (OAuth2, login-темы) с artstore.kryukov.lan.
# Вынесен в artstore-infra, чтобы Keycloak был доступен без artstore-apps.
{{- if .Values.httproute.enabled }}
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: keycloak
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: identity-provider
spec:
  parentRefs:
    - name: {{ .Values.httproute.gateway.name }}
      namespace: {{ .Values.httproute.gateway.namespace }}
  hostnames:
    - {{ .Values.httproute.hostname | quote }}
  rules:
    # Keycloak — OAuth2/OIDC endpoints (login, token, userinfo, certs)
    # Browser redirect идёт на artstore.kryukov.lan/realms/...
    - matches:
        - path:
            type: PathPrefix
            value: /realms
      backendRefs:
        - name: {{ .Release.Name }}-keycloak
          port: 8080
    # Keycloak — статические ресурсы (темы, CSS, JS, шрифты для login-страницы)
    - matches:
        - path:
            type: PathPrefix
            value: /resources
      backendRefs:
        - name: {{ .Release.Name }}-keycloak
          port: 8080
    # Keycloak — JS ресурсы (admin console)
    - matches:
        - path:
            type: PathPrefix
            value: /js
      backendRefs:
        - name: {{ .Release.Name }}-keycloak
          port: 8080
    # Keycloak Admin Console
    - matches:
        - path:
            type: PathPrefix
            value: /admin/master
      backendRefs:
        - name: {{ .Release.Name }}-keycloak
          port: 8080
    - matches:
        - path:
            type: PathPrefix
            value: /admin/realms
      backendRefs:
        - name: {{ .Release.Name }}-keycloak
          port: 8080
{{- end }}
