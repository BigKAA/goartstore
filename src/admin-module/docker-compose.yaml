# Docker Compose для разработки Admin Module
# Запускает PostgreSQL + Keycloak + Admin Module
#
# Использование:
#   docker compose up -d
#   curl http://localhost:8000/health/live
#   docker compose down

services:
  # PostgreSQL 17 — основная БД Admin Module
  postgresql:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: artsore
      POSTGRES_USER: artsore
      POSTGRES_PASSWORD: artsore-dev-password
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U artsore"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Keycloak 26.1 — Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:26.1
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgresql:5432/artsore
      KC_DB_USERNAME: artsore
      KC_DB_PASSWORD: artsore-dev-password
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_HTTP_PORT: 8080
    ports:
      - "8080:8080"
    depends_on:
      postgresql:
        condition: service_healthy

  # Admin Module
  admin-module:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: dev
    environment:
      AM_PORT: "8000"
      AM_LOG_LEVEL: debug
      AM_LOG_FORMAT: json
      # PostgreSQL
      AM_DB_HOST: postgresql
      AM_DB_PORT: "5432"
      AM_DB_NAME: artsore
      AM_DB_USER: artsore
      AM_DB_PASSWORD: artsore-dev-password
      AM_DB_SSL_MODE: disable
      # Keycloak
      AM_KEYCLOAK_URL: http://keycloak:8080
      AM_KEYCLOAK_REALM: artsore
      AM_KEYCLOAK_CLIENT_ID: artsore-admin-module
      AM_KEYCLOAK_CLIENT_SECRET: dev-secret
      # Фоновые задачи (Phase 5)
      AM_SYNC_INTERVAL: "1h"
      AM_SYNC_PAGE_SIZE: "1000"
      AM_SA_SYNC_INTERVAL: "15m"
      # topologymetrics
      AM_DEPHEALTH_CHECK_INTERVAL: "15s"
      AM_DEPHEALTH_GROUP: admin-module
    ports:
      - "8000:8000"
    depends_on:
      postgresql:
        condition: service_healthy
      keycloak:
        condition: service_started

volumes:
  pgdata:
