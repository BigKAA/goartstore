# Admin Module — production Helm chart values
# Stateless HTTP-сервис, TLS termination на API Gateway

# --- Образ контейнера ---
registry: harbor.kryukov.lan
image: library/admin-module
tag: latest
imagePullPolicy: IfNotPresent

# --- Реплики ---
replicas: 1

# --- Сервер ---
port: 8000
logLevel: info
logFormat: json

# --- PostgreSQL ---
database:
  host: ""          # обязательный: хост PostgreSQL
  port: 5432
  name: artstore
  user: artstore
  password: ""      # обязательный: пароль PostgreSQL
  sslMode: disable  # disable, require, verify-ca, verify-full

# --- Keycloak ---
keycloak:
  url: ""              # обязательный: URL Keycloak (например, https://keycloak.kryukov.lan)
  realm: artstore
  clientId: ""         # обязательный: Client ID для Admin API
  clientSecret: ""     # обязательный: Client Secret для Admin API
  saPrefix: "sa_"      # префикс client_id для Service Accounts

# --- JWT ---
jwt:
  # Авто-вычисляются из keycloak.url, если не заданы
  # issuer: ""
  # jwksUrl: ""
  rolesClaim: "realm_access.roles"
  groupsClaim: "groups"

# --- Маппинг групп Keycloak → ролей AM ---
rbac:
  adminGroups: "artstore-admins"
  readonlyGroups: "artstore-viewers"

# --- Синхронизация ---
sync:
  # Интервал синхронизации файлового реестра с SE
  interval: "1h"
  # Размер страницы при постраничной синхронизации
  pageSize: 1000
  # Интервал синхронизации Service Accounts с Keycloak
  saInterval: "15m"

# --- TLS ---
# AM не использует собственный TLS — HTTP внутри кластера,
# TLS termination выполняется на API Gateway.
# CA-сертификат используется для TLS-соединений к SE и другим внутренним сервисам.
tls:
  # Существующий Secret с CA-сертификатом для TLS-соединений
  # Если задан — монтируется в /certs и AM_CA_CERT_PATH=/certs/ca.crt
  caSecret: ""
  # Разрешить подключение к сервисам с невалидными TLS-сертификатами
  # ВНИМАНИЕ: использовать только для dev/test окружений!
  # skipVerify: false

# --- Dependency health (topologymetrics) ---
dephealth:
  checkInterval: "15s"
  group: "core-modules"
  isEntry: false

# --- Admin UI ---
ui:
  enabled: true
  # Секрет для шифрования session cookie (AES-256-GCM, 32 bytes hex/base64)
  # Если пусто — автогенерация при запуске (не сохраняется между рестартами!)
  sessionSecret: ""
  # OIDC Client ID (public client в Keycloak, Authorization Code + PKCE)
  oidcClientId: "artstore-admin-ui"

# --- Таймауты HTTP-клиентов ---
# Глобальный таймаут для всех исходящих HTTP-запросов.
# Per-client таймауты (если заданы) переопределяют глобальный.
# timeouts:
#   httpClient: "30s"           # AM_HTTP_CLIENT_TIMEOUT (глобальный)
#   keycloakClient: ""          # AM_KEYCLOAK_CLIENT_TIMEOUT (→ httpClient если пусто)
#   seClient: ""                # AM_SE_CLIENT_TIMEOUT (→ httpClient если пусто)
#   jwksClient: ""              # AM_JWKS_CLIENT_TIMEOUT (→ httpClient если пусто)
#   oidcClient: ""              # AM_OIDC_CLIENT_TIMEOUT (→ httpClient если пусто)
#   prometheusClient: ""        # AM_PROMETHEUS_CLIENT_TIMEOUT (→ httpClient если пусто)
#   # --- Таймауты HTTP-сервера ---
#   httpRead: "30s"             # AM_HTTP_READ_TIMEOUT
#   httpWrite: "60s"            # AM_HTTP_WRITE_TIMEOUT
#   httpIdle: "120s"            # AM_HTTP_IDLE_TIMEOUT
#   # --- Keycloak ---
#   keycloakReadiness: "5s"     # AM_KEYCLOAK_READINESS_TIMEOUT
#   keycloakTokenRefresh: "30s" # AM_KEYCLOAK_TOKEN_REFRESH_THRESHOLD
#   # --- JWT/JWKS ---
#   jwksRefreshInterval: "15s"  # AM_JWKS_REFRESH_INTERVAL
#   jwtLeeway: "5s"             # AM_JWT_LEEWAY
#   # --- UI ---
#   sseInterval: "15s"          # AM_SSE_INTERVAL

# --- Graceful shutdown ---
shutdownTimeout: "5s"

# --- HTTPRoute (Gateway API) ---
# Внешний доступ через API Gateway (Envoy Gateway)
httproute:
  enabled: false
  gatewayName: eg
  gatewayNamespace: envoy-gateway-system
  hostname: "artstore.kryukov.lan"
  pathPrefixes:
    - /api/v1
    - /health
    - /admin
    - /static

# --- Prometheus метрики ---
metrics:
  enabled: true
  path: /metrics

# --- Ресурсы контейнера ---
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi
