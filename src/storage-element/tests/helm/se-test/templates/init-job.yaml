# Init Job — Helm post-install hook для инициализации тестовых данных.
# Загружает файлы в SE, переводит se-ro и se-ar в нужные режимы.
# Скрипты lib.sh и init-data.sh реализуются в Phase 6.3.
{{- if .Values.initJob.enabled }}
---
# ConfigMap с общей библиотекой функций (lib.sh)
apiVersion: v1
kind: ConfigMap
metadata:
  name: se-test-init-lib
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "se-test.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: post-install
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation
data:
  # Общая библиотека функций для init и тестовых скриптов.
  # Полная реализация — Phase 6.3.
  lib.sh: |
    #!/usr/bin/env bash
    # ==========================================================================
    # lib.sh — общая библиотека функций для SE тестовых скриптов
    # Полная реализация в Phase 6.3
    # ==========================================================================
    set -euo pipefail

    # Цветной вывод
    log_info()  { echo -e "\033[0;34m[INFO]\033[0m  $*"; }
    log_ok()    { echo -e "\033[0;32m[OK]\033[0m    $*"; }
    log_fail()  { echo -e "\033[0;31m[FAIL]\033[0m  $*"; }
    log_warn()  { echo -e "\033[0;33m[WARN]\033[0m  $*"; }

    # Placeholder — будет реализовано в Phase 6.3
    get_token()       { log_warn "get_token: placeholder (Phase 6.3)"; }
    wait_ready()      { log_warn "wait_ready: placeholder (Phase 6.3)"; }
    upload_file()     { log_warn "upload_file: placeholder (Phase 6.3)"; }
    transition_mode() { log_warn "transition_mode: placeholder (Phase 6.3)"; }
    assert_status()   { log_warn "assert_status: placeholder (Phase 6.3)"; }
---
# ConfigMap со скриптом инициализации данных
apiVersion: v1
kind: ConfigMap
metadata:
  name: se-test-init-data
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "se-test.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: post-install
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation
data:
  # Скрипт инициализации тестовых данных.
  # Полная реализация — Phase 6.3.
  init-data.sh: |
    #!/usr/bin/env bash
    # ==========================================================================
    # init-data.sh — инициализация тестовых данных
    # Полная реализация в Phase 6.3
    # ==========================================================================
    set -euo pipefail
    source /scripts/lib.sh

    log_info "=== SE Test Environment Init ==="
    log_warn "Скрипт инициализации ещё не реализован (Phase 6.3)"
    log_info "=== Init complete ==="
---
# Job (post-install hook) — запускает init-data.sh после деплоя
apiVersion: batch/v1
kind: Job
metadata:
  name: se-test-init
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "se-test.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: post-install
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  activeDeadlineSeconds: {{ .Values.initJob.activeDeadlineSeconds }}
  backoffLimit: 2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: se-test-init
    spec:
      restartPolicy: Never
      containers:
        - name: init
          image: alpine:3.19
          command: ["/bin/bash", "/scripts/init-data.sh"]
          env:
            # URL JWKS Mock для получения JWT
            - name: JWKS_MOCK_URL
              value: "https://jwks-mock.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.jwksMock.port }}"
            # URL всех SE экземпляров
            {{- range .Values.replicatedInstances }}
            - name: {{ .name | upper | replace "-" "_" }}_URL
              value: "https://{{ .name }}.{{ $.Values.namespace }}.svc.cluster.local:{{ $.Values.seCommon.port }}"
            {{- end }}
            {{- range .Values.standaloneInstances }}
            - name: {{ .name | upper | replace "-" "_" }}_URL
              value: "https://{{ .name }}.{{ $.Values.namespace }}.svc.cluster.local:{{ $.Values.seCommon.port }}"
            {{- end }}
            # Опции curl (пропуск проверки TLS для self-signed сертификатов)
            - name: CURL_OPTS
              value: "-k -s --connect-timeout 5"
          volumeMounts:
            - name: init-lib
              mountPath: /scripts/lib.sh
              subPath: lib.sh
            - name: init-data
              mountPath: /scripts/init-data.sh
              subPath: init-data.sh
      volumes:
        - name: init-lib
          configMap:
            name: se-test-init-lib
            defaultMode: 0755
        - name: init-data
          configMap:
            name: se-test-init-data
            defaultMode: 0755
{{- end }}
