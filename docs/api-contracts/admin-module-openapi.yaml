# OpenAPI спецификация для Admin Module
# Модуль: Admin Module (управление SE, файловый реестр, SA, role overrides)
# Версия API: v1
# Версия спецификации: 0.1.0
# Дата фиксации: 2026-02-22
#
# Аутентификация полностью делегирована Keycloak (IdP).
# 29 endpoints: admin-auth/me, admin-users (5), SA (6), SE (7),
# files (5), idp (2), health (3).

openapi: 3.0.3

info:
  title: Admin Module API
  description: |
    Admin Module — управляющий модуль системы Artsore.

    **Admin Module не является auth-сервером.** Аутентификация и выдача JWT
    полностью делегированы внешнему Identity Provider (Keycloak). Admin Module
    получает JWT от API Gateway, проверяет claims (роли, scopes) и принимает
    решения по авторизации для своих endpoints.

    ## Аутентификация

    Все запросы (кроме Health) проходят через API Gateway, который:
    - Проверяет подпись JWT через JWKS Keycloak
    - Проверяет expiration
    - Форвардит claims в заголовках к Admin Module

    ### Admin Users (H2M)
    Аутентификация через Keycloak OIDC (Authorization Code + PKCE).
    JWT содержит `sub`, `realm_access.roles`, `groups`.

    Роли определяются маппингом Keycloak groups → Artsore roles:
    - `artsore-admins` → `admin` (полный доступ)
    - `artsore-viewers` → `readonly` (только чтение)

    Admin Module может **дополнить** (но не понизить) роль через
    локальные role overrides.

    ### Service Accounts (M2M)
    OAuth 2.0 Client Credentials flow через Keycloak.
    JWT содержит `client_id`, `scope`.

    Scopes:
    - `files:read` — чтение метаданных и скачивание файлов
    - `files:write` — загрузка, обновление и удаление файлов
    - `storage:read` — чтение информации о Storage Elements
    - `storage:write` — управление SE (sync, mode transition)
    - `admin:read` — чтение административных данных
    - `admin:write` — управление пользователями и SA

    ## Shared PostgreSQL
    Admin Module и Query Module используют один PostgreSQL instance.
    Admin Module владеет таблицами и пишет. Query Module добавляет
    FTS-индексы и читает.

    ## Синхронизация файлового реестра

    `*.attr.json` файлы на Storage Elements — **единственный источник истины**
    для метаданных файлов. Файловый реестр в PostgreSQL — вторичный индекс,
    восстанавливаемый из attr.json.

    4 механизма синхронизации:
    1. **Периодический sync** — фоновая задача (интервал 1 час, конфигурируемый)
    2. **Ленивая очистка** — Query Module помечает файл при 404 от SE
    3. **Ручной sync** — `POST /storage-elements/{id}/sync`
    4. **Full sync** — автоматически при регистрации SE
  version: 0.1.0
  contact:
    name: Artsore Team
  license:
    name: Private
    url: https://github.com/arturkryukov/artsore

servers:
  - url: https://{host}
    description: API Gateway (внешний доступ)
    variables:
      host:
        default: artstore.kryukov.lan
  - url: http://{host}:{port}
    description: Admin Module instance (прямой доступ, health/metrics)
    variables:
      host:
        default: localhost
      port:
        default: "8000"
        description: Порт из диапазона 8000-8009

tags:
  - name: admin-auth
    description: Текущий пользователь (данные из JWT + локальные дополнения)
  - name: admin-users
    description: |
      Управление пользователями. Пользователи хранятся в Keycloak.
      Admin Module предоставляет read-доступ и локальные дополнения ролей.
  - name: service-accounts
    description: |
      Управление сервисными аккаунтами. Параллельное управление
      в Admin Module и Keycloak с периодической синхронизацией.
  - name: storage-elements
    description: Реестр Storage Elements — регистрация, discover, sync
  - name: files
    description: Реестр файлов (file registry) — вторичный индекс метаданных
  - name: idp
    description: Статус Identity Provider (Keycloak) и синхронизация SA
  - name: health
    description: Kubernetes probes и Prometheus метрики

# ---------------------------------------------------------------------------
# Пути (Paths) — 29 endpoints
# ---------------------------------------------------------------------------
paths:

  # =========================================================================
  # Admin Auth — текущий пользователь (1 endpoint)
  # =========================================================================

  /api/v1/admin-auth/me:
    get:
      tags: [admin-auth]
      summary: Текущий пользователь
      description: |
        Возвращает информацию о текущем аутентифицированном пользователе:
        данные из JWT claims + локальные дополнения ролей из Admin Module.

        Итоговая роль = max(роль из IdP, локальное дополнение).
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Информация о текущем пользователе
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CurrentUser"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  # =========================================================================
  # Admin Users (5 endpoints)
  # =========================================================================

  /api/v1/admin-users:
    get:
      tags: [admin-users]
      summary: Список пользователей
      description: |
        Возвращает пагинированный список пользователей.
        Данные берутся из Keycloak (через Admin API) и дополняются
        локальными role overrides из Admin Module.

        Доступно ролям `admin` и `readonly`.
      operationId: listAdminUsers
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      responses:
        "200":
          description: Список пользователей
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUserListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/admin-users/{id}:
    get:
      tags: [admin-users]
      summary: Получить пользователя
      description: |
        Возвращает данные пользователя по Keycloak user ID.
        Включает данные из Keycloak + локальные дополнения ролей.

        Доступно ролям `admin` и `readonly`.
      operationId: getAdminUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserId"
      responses:
        "200":
          description: Данные пользователя
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUser"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags: [admin-users]
      summary: Обновить локальные дополнения пользователя
      description: |
        Обновление локальных дополнений пользователя (role override).
        Может только **повысить** роль, не понизить.

        Создание и удаление пользователей, сброс паролей —
        выполняются в Keycloak.

        Доступно только роли `admin`.
      operationId: updateAdminUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminUserUpdate"
      responses:
        "200":
          description: Пользователь обновлён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUser"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [admin-users]
      summary: Удалить локальные дополнения пользователя
      description: |
        Удаляет локальные дополнения (role override) для пользователя.
        Пользователь продолжит существовать в Keycloak с ролью из IdP.

        Доступно только роли `admin`.
      operationId: deleteAdminUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserId"
      responses:
        "204":
          description: Локальные дополнения удалены
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/admin-users/{id}/role-override:
    post:
      tags: [admin-users]
      summary: Установить/изменить локальное дополнение роли
      description: |
        Устанавливает или изменяет локальное дополнение роли для пользователя.

        **Правила:**
        - Можно только **повысить** роль (readonly → admin), не понизить
        - Итоговая роль = max(роль из IdP, локальное дополнение)
        - Если у пользователя в IdP уже `admin`, override `readonly`
          не имеет эффекта (но сохраняется для логирования)

        Доступно только роли `admin`.
      operationId: setRoleOverride
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoleOverrideRequest"
      responses:
        "200":
          description: Role override установлен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUser"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Пользователь не найден в Keycloak
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalError"

  # =========================================================================
  # Service Accounts (6 endpoints)
  # =========================================================================

  /api/v1/service-accounts:
    post:
      tags: [service-accounts]
      summary: Создать сервисный аккаунт
      description: |
        Создание нового SA. Автоматически синхронизируется в Keycloak
        (создаётся confidential client с Client Credentials flow).

        Credentials (client_id, client_secret) генерируются Keycloak.
        **client_secret возвращается только один раз** в ответе на создание.

        Доступно только роли `admin`.
      operationId: createServiceAccount
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ServiceAccountCreate"
      responses:
        "201":
          description: SA создан (client_secret в ответе!)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceAccountWithSecret"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Имя уже занято
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: CONFLICT
                  message: "Сервисный аккаунт с таким именем уже существует"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      tags: [service-accounts]
      summary: Список сервисных аккаунтов
      description: |
        Возвращает пагинированный список SA.
        Доступно ролям `admin` и `readonly`.
      operationId: listServiceAccounts
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - name: status
          in: query
          description: Фильтр по статусу
          schema:
            type: string
            enum: [active, suspended]
      responses:
        "200":
          description: Список SA
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceAccountListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/service-accounts/{id}:
    get:
      tags: [service-accounts]
      summary: Получить сервисный аккаунт
      description: |
        Возвращает данные SA по ID.
        Доступно ролям `admin` и `readonly`.
      operationId: getServiceAccount
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ServiceAccountId"
      responses:
        "200":
          description: Данные SA
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceAccount"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags: [service-accounts]
      summary: Обновить сервисный аккаунт
      description: |
        Обновление SA (name, description, scopes, status).
        Изменения синхронизируются в Keycloak.
        Для изменения secret используйте `rotate-secret`.

        Доступно только роли `admin`.
      operationId: updateServiceAccount
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ServiceAccountId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ServiceAccountUpdate"
      responses:
        "200":
          description: SA обновлён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceAccount"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [service-accounts]
      summary: Удалить сервисный аккаунт
      description: |
        Удаление SA. Синхронно удаляется client в Keycloak.
        Доступно только роли `admin`.
      operationId: deleteServiceAccount
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ServiceAccountId"
      responses:
        "204":
          description: SA удалён
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/service-accounts/{id}/rotate-secret:
    post:
      tags: [service-accounts]
      summary: Ротация secret
      description: |
        Генерирует новый `client_secret` для SA в Keycloak.
        Старый secret немедленно становится невалидным.
        Новый secret возвращается **только один раз** в ответе.

        Доступно только роли `admin`.
      operationId: rotateSecret
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ServiceAccountId"
      responses:
        "200":
          description: Secret обновлён (новый secret в ответе!)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RotateSecretResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # =========================================================================
  # Storage Elements (7 endpoints)
  # =========================================================================

  /api/v1/storage-elements/discover:
    post:
      tags: [storage-elements]
      summary: Предпросмотр Storage Element
      description: |
        Запрашивает информацию о SE по указанному URL (вызывает
        `GET /api/v1/info` на SE) и возвращает результат.
        **Не создаёт запись** — только предпросмотр.

        Доступно ролям `admin` и `readonly`.
      operationId: discoverStorageElement
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DiscoverRequest"
      responses:
        "200":
          description: Информация о SE получена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DiscoverResponse"
        "400":
          description: Некорректный URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "502":
          description: SE недоступен или вернул ошибку
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: SE_UNAVAILABLE
                  message: "Не удалось подключиться к Storage Element"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/storage-elements:
    post:
      tags: [storage-elements]
      summary: Регистрация Storage Element
      description: |
        Регистрирует новый SE в системе. При регистрации автоматически:
        1. Запрашивает `GET /api/v1/info` на SE
        2. Запускает **full sync файловых метаданных**

        Доступно только роли `admin`.
      operationId: createStorageElement
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StorageElementCreate"
      responses:
        "201":
          description: SE зарегистрирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StorageElement"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: SE с таким URL уже зарегистрирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: CONFLICT
                  message: "Storage Element с таким URL уже зарегистрирован"
        "502":
          description: Не удалось получить информацию от SE
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      tags: [storage-elements]
      summary: Список Storage Elements
      description: |
        Возвращает пагинированный список зарегистрированных SE.
        Используется Admin UI, Ingester и Query Module.

        Доступно: роли `admin`, `readonly`, SA с scope `storage:read`.
      operationId: listStorageElements
      security:
        - bearerAuth: [storage:read]
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - name: mode
          in: query
          description: Фильтр по режиму работы
          schema:
            type: string
            enum: [edit, rw, ro, ar]
        - name: status
          in: query
          description: Фильтр по статусу
          schema:
            type: string
            enum: [online, offline, degraded, maintenance]
      responses:
        "200":
          description: Список SE
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StorageElementListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/storage-elements/{id}:
    get:
      tags: [storage-elements]
      summary: Получить Storage Element
      description: |
        Возвращает данные SE по ID.
        Доступно: роли `admin`, `readonly`, SA с scope `storage:read`.
      operationId: getStorageElement
      security:
        - bearerAuth: [storage:read]
      parameters:
        - $ref: "#/components/parameters/StorageElementId"
      responses:
        "200":
          description: Данные SE
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StorageElement"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags: [storage-elements]
      summary: Обновить Storage Element
      description: |
        Обновление данных SE (name, url).
        Mode, status, capacity обновляются через sync.
        Доступно только роли `admin`.
      operationId: updateStorageElement
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/StorageElementId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StorageElementUpdate"
      responses:
        "200":
          description: SE обновлён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StorageElement"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [storage-elements]
      summary: Удалить Storage Element
      description: |
        Удаление SE из реестра. Физические файлы на SE не удаляются.
        Доступно только роли `admin`.
      operationId: deleteStorageElement
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/StorageElementId"
      responses:
        "204":
          description: SE удалён из реестра
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/storage-elements/{id}/sync:
    post:
      tags: [storage-elements]
      summary: Синхронизация Storage Element
      description: |
        Полная синхронизация SE:
        1. `GET /api/v1/info` → обновить mode, status, capacity
        2. Постраничный `GET /api/v1/files` → синхронизировать file_registry

        `*.attr.json` на SE — единственный источник истины.

        Доступно роли `admin` и SA с scope `storage:write`.
      operationId: syncStorageElement
      security:
        - bearerAuth: [storage:write]
      parameters:
        - $ref: "#/components/parameters/StorageElementId"
      responses:
        "200":
          description: SE синхронизирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          description: Не удалось подключиться к SE
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: SE_UNAVAILABLE
                  message: "Не удалось подключиться к Storage Element"
        "500":
          $ref: "#/components/responses/InternalError"

  # =========================================================================
  # Files Registry (5 endpoints)
  # =========================================================================

  /api/v1/files:
    post:
      tags: [files]
      summary: Регистрация файла
      description: |
        Регистрирует файл в реестре после загрузки на SE.
        Вызывается Ingester Module.

        Доступно SA с scope `files:write`.
      operationId: registerFile
      security:
        - bearerAuth: [files:write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FileRegisterRequest"
      responses:
        "201":
          description: Файл зарегистрирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileRecord"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Файл с таким ID уже зарегистрирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      tags: [files]
      summary: Список файлов
      description: |
        Возвращает пагинированный список файлов из реестра.

        Доступно: SA с scope `files:read`, роли `admin`, `readonly`.
      operationId: listFiles
      security:
        - bearerAuth: [files:read]
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - name: status
          in: query
          description: Фильтр по статусу
          schema:
            type: string
            enum: [active, expired, deleted]
        - name: retention_policy
          in: query
          description: Фильтр по политике хранения
          schema:
            type: string
            enum: [temporary, permanent]
        - name: storage_element_id
          in: query
          description: Фильтр по Storage Element
          schema:
            type: string
            format: uuid
        - name: uploaded_by
          in: query
          description: Фильтр по загрузившему
          schema:
            type: string
      responses:
        "200":
          description: Список файлов
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileRecordListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/files/{file_id}:
    get:
      tags: [files]
      summary: Метаданные файла
      description: |
        Возвращает метаданные файла из реестра.

        Доступно: SA с scope `files:read`, роли `admin`, `readonly`.
      operationId: getFile
      security:
        - bearerAuth: [files:read]
      parameters:
        - $ref: "#/components/parameters/FileId"
      responses:
        "200":
          description: Метаданные файла
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileRecord"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags: [files]
      summary: Обновление метаданных файла
      description: |
        Обновление метаданных файла в реестре (description, tags, status).

        Доступно: SA с scope `files:write`, роль `admin`.
      operationId: updateFile
      security:
        - bearerAuth: [files:write]
      parameters:
        - $ref: "#/components/parameters/FileId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FileRecordUpdate"
      responses:
        "200":
          description: Метаданные обновлены
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileRecord"
        "400":
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [files]
      summary: Soft delete файла
      description: |
        Помечает файл как удалённый (status → `deleted`).
        Физическое удаление на SE выполняется GC на SE.

        Доступно: SA с scope `files:write`, роль `admin`.
      operationId: deleteFile
      security:
        - bearerAuth: [files:write]
      parameters:
        - $ref: "#/components/parameters/FileId"
      responses:
        "204":
          description: Файл помечен как удалённый
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # =========================================================================
  # IdP Status (2 endpoints)
  # =========================================================================

  /api/v1/idp/status:
    get:
      tags: [idp]
      summary: Статус Identity Provider
      description: |
        Возвращает статус подключения к Keycloak:
        доступность, информация о realm, количество пользователей,
        последняя синхронизация SA.

        Доступно только роли `admin`.
      operationId: getIdpStatus
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Статус IdP
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IdpStatus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/idp/sync-sa:
    post:
      tags: [idp]
      summary: Принудительная синхронизация SA
      description: |
        Запускает немедленную синхронизацию Service Accounts
        между локальной БД и Keycloak.

        Доступно только роли `admin`.
      operationId: syncServiceAccounts
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Синхронизация завершена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SASyncResult"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  # =========================================================================
  # Health (3 endpoints)
  # =========================================================================

  /health/live:
    get:
      tags: [health]
      summary: Liveness probe
      description: |
        Kubernetes liveness probe. Возвращает 200, если процесс жив.
        Доступен напрямую к pod, минуя API Gateway.
      operationId: healthLive
      security: []
      responses:
        "200":
          description: Сервис жив
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthLiveResponse"
        "500":
          $ref: "#/components/responses/InternalError"

  /health/ready:
    get:
      tags: [health]
      summary: Readiness probe
      description: |
        Kubernetes readiness probe.
        Проверяет: PostgreSQL, Keycloak доступность.
        Доступен напрямую к pod, минуя API Gateway.
      operationId: healthReady
      security: []
      responses:
        "200":
          description: Сервис готов (ok или degraded)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthReadyResponse"
        "500":
          $ref: "#/components/responses/InternalError"
        "503":
          description: Сервис не готов (fail)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthReadyResponse"

  /metrics:
    get:
      tags: [health]
      summary: Prometheus metrics
      description: |
        Метрики в формате Prometheus. Включает метрики зависимостей
        topologymetrics (app_dependency_health, app_dependency_latency_seconds).
        Доступен напрямую к pod, минуя API Gateway.
      operationId: getMetrics
      security: []
      responses:
        "200":
          description: Метрики Prometheus
          content:
            text/plain:
              schema:
                type: string
        "500":
          $ref: "#/components/responses/InternalError"

# ---------------------------------------------------------------------------
# Компоненты (Components)
# ---------------------------------------------------------------------------
components:

  # =========================================================================
  # Схемы безопасности
  # =========================================================================
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT от Keycloak. Валидация подписи — на API Gateway.
        Admin Module проверяет claims (роли, scopes).

        Для Admin Users: `realm_access.roles`, `groups`
        Для Service Accounts: `scope`

  # =========================================================================
  # Параметры
  # =========================================================================
  parameters:
    Limit:
      name: limit
      in: query
      description: Количество записей на странице
      schema:
        type: integer
        minimum: 1
        maximum: 1000
        default: 100

    Offset:
      name: offset
      in: query
      description: Смещение от начала списка
      schema:
        type: integer
        minimum: 0
        default: 0

    UserId:
      name: id
      in: path
      required: true
      description: Keycloak user ID (UUID)
      schema:
        type: string

    ServiceAccountId:
      name: id
      in: path
      required: true
      description: UUID сервисного аккаунта
      schema:
        type: string
        format: uuid

    StorageElementId:
      name: id
      in: path
      required: true
      description: UUID Storage Element
      schema:
        type: string
        format: uuid

    FileId:
      name: file_id
      in: path
      required: true
      description: UUID файла
      schema:
        type: string
        format: uuid

  # =========================================================================
  # Переиспользуемые ответы
  # =========================================================================
  responses:
    Unauthorized:
      description: Отсутствует или невалидный JWT token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: UNAUTHORIZED
              message: "Требуется аутентификация"

    Forbidden:
      description: Недостаточно прав
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: FORBIDDEN
              message: "Недостаточно прав для выполнения операции"

    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: NOT_FOUND
              message: "Ресурс не найден"

    InternalError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: INTERNAL_ERROR
              message: "Внутренняя ошибка сервера"

  # =========================================================================
  # Схемы данных
  # =========================================================================
  schemas:

    # -----------------------------------------------------------------------
    # Admin Auth
    # -----------------------------------------------------------------------

    CurrentUser:
      type: object
      description: Текущий пользователь (данные из JWT + локальные дополнения)
      required:
        - id
        - username
        - idp_role
        - effective_role
      properties:
        id:
          type: string
          description: Keycloak user ID (sub из JWT)
          example: "550e8400-e29b-41d4-a716-446655440000"
        username:
          type: string
          description: Имя пользователя (из JWT preferred_username)
          example: alice
        email:
          type: string
          format: email
          nullable: true
          example: alice@example.com
        groups:
          type: array
          items:
            type: string
          description: Группы пользователя из IdP
          example: ["artsore-admins"]
        idp_role:
          type: string
          enum: [admin, readonly]
          description: Роль из IdP (на основе маппинга groups → roles)
          example: admin
        role_override:
          type: string
          enum: [admin, readonly]
          nullable: true
          description: Локальное дополнение роли (из Admin Module БД)
        effective_role:
          type: string
          enum: [admin, readonly]
          description: Итоговая роль = max(idp_role, role_override)
          example: admin

    # -----------------------------------------------------------------------
    # Admin Users
    # -----------------------------------------------------------------------

    AdminUser:
      type: object
      description: Пользователь (данные из Keycloak + локальные дополнения)
      required:
        - id
        - username
        - idp_role
        - effective_role
        - created_at
      properties:
        id:
          type: string
          description: Keycloak user ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        username:
          type: string
          example: alice
        email:
          type: string
          format: email
          nullable: true
          example: alice@example.com
        first_name:
          type: string
          nullable: true
          example: Alice
        last_name:
          type: string
          nullable: true
          example: Johnson
        groups:
          type: array
          items:
            type: string
          description: Группы пользователя из IdP
          example: ["artsore-admins"]
        idp_role:
          type: string
          enum: [admin, readonly]
          description: Роль из IdP
          example: readonly
        role_override:
          type: string
          enum: [admin, readonly]
          nullable: true
          description: Локальное дополнение роли
          example: admin
        effective_role:
          type: string
          enum: [admin, readonly]
          description: Итоговая роль = max(idp_role, role_override)
          example: admin
        enabled:
          type: boolean
          description: Активен ли аккаунт в Keycloak
          example: true
        created_at:
          type: string
          format: date-time
          description: Дата создания в Keycloak
          example: "2026-02-21T10:00:00Z"

    AdminUserUpdate:
      type: object
      description: Обновление локальных дополнений пользователя
      properties:
        role_override:
          type: string
          enum: [admin, readonly]
          nullable: true
          description: |
            Локальное дополнение роли.
            Установите `null` для удаления override.
      minProperties: 1

    RoleOverrideRequest:
      type: object
      description: Установка локального дополнения роли
      required:
        - role
      properties:
        role:
          type: string
          enum: [admin, readonly]
          description: Роль для локального дополнения
          example: admin

    AdminUserListResponse:
      type: object
      required:
        - items
        - total
        - limit
        - offset
        - has_more
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AdminUser"
        total:
          type: integer
          example: 5
        limit:
          type: integer
          example: 100
        offset:
          type: integer
          example: 0
        has_more:
          type: boolean
          example: false

    # -----------------------------------------------------------------------
    # Service Accounts
    # -----------------------------------------------------------------------

    ServiceAccount:
      type: object
      description: Сервисный аккаунт (без secret)
      required:
        - id
        - client_id
        - name
        - scopes
        - status
        - source
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        keycloak_client_id:
          type: string
          nullable: true
          description: UUID client в Keycloak
        client_id:
          type: string
          description: Идентификатор для аутентификации (формат `sa_<name>_<random>`)
          example: sa_ingester_a1b2c3
        name:
          type: string
          description: Человекочитаемое имя
          example: ingester
        description:
          type: string
          nullable: true
          example: Сервисный аккаунт для Ingester Module
        scopes:
          type: array
          items:
            type: string
            enum:
              - files:read
              - files:write
              - storage:read
              - storage:write
              - admin:read
              - admin:write
          example: [files:write, storage:read]
        status:
          type: string
          enum: [active, suspended]
          example: active
        source:
          type: string
          enum: [keycloak, local]
          description: |
            Источник создания SA:
            - `local` — создан через Admin Module
            - `keycloak` — обнаружен при синхронизации с Keycloak
          example: local
        last_synced_at:
          type: string
          format: date-time
          nullable: true
          description: Время последней синхронизации с Keycloak
        created_at:
          type: string
          format: date-time
          example: "2026-02-21T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-21T10:00:00Z"

    ServiceAccountWithSecret:
      description: SA с secret (возвращается только при создании)
      allOf:
        - $ref: "#/components/schemas/ServiceAccount"
        - type: object
          required:
            - client_secret
          properties:
            client_secret:
              type: string
              description: |
                Секрет для аутентификации от Keycloak.
                **Показывается только один раз!**
              example: cs_random_secret_value

    ServiceAccountCreate:
      type: object
      required:
        - name
        - scopes
      properties:
        name:
          type: string
          description: Имя SA (используется в client_id)
          minLength: 2
          maxLength: 50
          example: ingester
        description:
          type: string
          maxLength: 500
          example: Сервисный аккаунт для Ingester Module
        scopes:
          type: array
          items:
            type: string
            enum:
              - files:read
              - files:write
              - storage:read
              - storage:write
              - admin:read
              - admin:write
          minItems: 1
          example: [files:write, storage:read]

    ServiceAccountUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 50
        description:
          type: string
          maxLength: 500
        scopes:
          type: array
          items:
            type: string
            enum:
              - files:read
              - files:write
              - storage:read
              - storage:write
              - admin:read
              - admin:write
          minItems: 1
        status:
          type: string
          enum: [active, suspended]
      minProperties: 1

    RotateSecretResponse:
      type: object
      required:
        - client_id
        - client_secret
      properties:
        client_id:
          type: string
          example: sa_ingester_a1b2c3
        client_secret:
          type: string
          description: Новый секрет от Keycloak. **Показывается только один раз!**
          example: cs_new_random_secret

    ServiceAccountListResponse:
      type: object
      required:
        - items
        - total
        - limit
        - offset
        - has_more
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/ServiceAccount"
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        has_more:
          type: boolean

    # -----------------------------------------------------------------------
    # Storage Elements
    # -----------------------------------------------------------------------

    StorageElement:
      type: object
      description: Зарегистрированный Storage Element
      required:
        - id
        - name
        - url
        - storage_id
        - mode
        - status
        - capacity_bytes
        - used_bytes
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: 770e8400-e29b-41d4-a716-446655440002
        name:
          type: string
          example: Moscow SE 01
        url:
          type: string
          format: uri
          example: https://se-moscow-01.kryukov.lan:8010
        storage_id:
          type: string
          description: Идентификатор SE (из SE /api/v1/info)
          example: se-moscow-01
        mode:
          type: string
          enum: [edit, rw, ro, ar]
          example: rw
        status:
          type: string
          enum: [online, offline, degraded, maintenance]
          example: online
        capacity_bytes:
          type: integer
          format: int64
          example: 107374182400
        used_bytes:
          type: integer
          format: int64
          example: 53687091200
        available_bytes:
          type: integer
          format: int64
          example: 53687091200
        last_sync_at:
          type: string
          format: date-time
          nullable: true
          description: Время последней синхронизации info
        last_file_sync_at:
          type: string
          format: date-time
          nullable: true
          description: Время последней синхронизации файлов
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StorageElementCreate:
      type: object
      required:
        - name
        - url
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: Moscow SE 01
        url:
          type: string
          format: uri
          example: https://se-moscow-01.kryukov.lan:8010

    StorageElementUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        url:
          type: string
          format: uri
      minProperties: 1

    DiscoverRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          format: uri
          example: https://se-moscow-01.kryukov.lan:8010

    DiscoverResponse:
      type: object
      description: Информация от SE (GET /api/v1/info)
      required:
        - storage_id
        - mode
        - status
        - version
        - capacity
      properties:
        storage_id:
          type: string
          example: se-moscow-01
        mode:
          type: string
          enum: [edit, rw, ro, ar]
        status:
          type: string
          enum: [online, offline, degraded, maintenance]
        version:
          type: string
          example: 1.0.0
        capacity:
          type: object
          properties:
            total_bytes:
              type: integer
              format: int64
            used_bytes:
              type: integer
              format: int64
            available_bytes:
              type: integer
              format: int64

    SyncResponse:
      type: object
      description: Результат синхронизации SE
      required:
        - storage_element
        - file_sync
      properties:
        storage_element:
          $ref: "#/components/schemas/StorageElement"
        file_sync:
          type: object
          required:
            - files_on_se
            - files_added
            - files_updated
            - files_marked_deleted
            - started_at
            - completed_at
          properties:
            files_on_se:
              type: integer
              example: 1523
            files_added:
              type: integer
              example: 5
            files_updated:
              type: integer
              example: 12
            files_marked_deleted:
              type: integer
              example: 3
            started_at:
              type: string
              format: date-time
            completed_at:
              type: string
              format: date-time

    StorageElementListResponse:
      type: object
      required:
        - items
        - total
        - limit
        - offset
        - has_more
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/StorageElement"
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        has_more:
          type: boolean

    # -----------------------------------------------------------------------
    # Files Registry
    # -----------------------------------------------------------------------

    FileRecord:
      type: object
      description: Запись файла в реестре
      required:
        - file_id
        - original_filename
        - content_type
        - size
        - checksum
        - storage_element_id
        - uploaded_by
        - uploaded_at
        - status
        - retention_policy
      properties:
        file_id:
          type: string
          format: uuid
        original_filename:
          type: string
          example: photo_landscape.jpg
        content_type:
          type: string
          example: image/jpeg
        size:
          type: integer
          format: int64
          example: 5242880
        checksum:
          type: string
          description: SHA-256
          example: a1b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef1234567890
        storage_element_id:
          type: string
          format: uuid
        uploaded_by:
          type: string
          example: sa_ingester_a1b2c3
        uploaded_at:
          type: string
          format: date-time
        description:
          type: string
          nullable: true
        tags:
          type: array
          items:
            type: string
          example: ["logo", "draft"]
        status:
          type: string
          enum: [active, expired, deleted]
          example: active
        retention_policy:
          type: string
          enum: [temporary, permanent]
          example: permanent
        ttl_days:
          type: integer
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    FileRegisterRequest:
      type: object
      description: Регистрация файла (от Ingester)
      required:
        - file_id
        - original_filename
        - content_type
        - size
        - checksum
        - storage_element_id
        - retention_policy
      properties:
        file_id:
          type: string
          format: uuid
        original_filename:
          type: string
        content_type:
          type: string
        size:
          type: integer
          format: int64
        checksum:
          type: string
        storage_element_id:
          type: string
          format: uuid
        description:
          type: string
          maxLength: 1000
        tags:
          type: array
          items:
            type: string
        retention_policy:
          type: string
          enum: [temporary, permanent]
        ttl_days:
          type: integer
          minimum: 1
          maximum: 365
          description: Обязателен для retention_policy=temporary

    FileRecordUpdate:
      type: object
      properties:
        description:
          type: string
          maxLength: 1000
        tags:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, expired, deleted]
      minProperties: 1

    FileRecordListResponse:
      type: object
      required:
        - items
        - total
        - limit
        - offset
        - has_more
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/FileRecord"
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        has_more:
          type: boolean

    # -----------------------------------------------------------------------
    # IdP
    # -----------------------------------------------------------------------

    IdpStatus:
      type: object
      description: Статус подключения к Identity Provider (Keycloak)
      required:
        - connected
        - realm
      properties:
        connected:
          type: boolean
          description: Доступен ли Keycloak
          example: true
        realm:
          type: string
          description: Имя realm
          example: artsore
        keycloak_url:
          type: string
          format: uri
          example: https://keycloak.kryukov.lan
        users_count:
          type: integer
          description: Количество пользователей в realm
          example: 5
        clients_count:
          type: integer
          description: Количество SA clients (с prefix sa_*)
          example: 3
        last_sa_sync_at:
          type: string
          format: date-time
          nullable: true
          description: Время последней синхронизации SA
        error:
          type: string
          nullable: true
          description: Сообщение об ошибке (если Keycloak недоступен)

    SASyncResult:
      type: object
      description: Результат синхронизации SA с Keycloak
      required:
        - created_local
        - created_keycloak
        - updated
        - total_local
        - total_keycloak
        - synced_at
      properties:
        created_local:
          type: integer
          description: Новых SA создано локально (обнаружены в Keycloak)
          example: 1
        created_keycloak:
          type: integer
          description: Новых clients создано в Keycloak (обнаружены локально)
          example: 0
        updated:
          type: integer
          description: SA обновлены (расхождение scopes)
          example: 2
        total_local:
          type: integer
          description: Общее количество SA в локальной БД
          example: 5
        total_keycloak:
          type: integer
          description: Общее количество SA clients в Keycloak
          example: 5
        synced_at:
          type: string
          format: date-time

    # -----------------------------------------------------------------------
    # Health
    # -----------------------------------------------------------------------

    HealthLiveResponse:
      type: object
      required:
        - status
        - timestamp
        - version
        - service
      properties:
        status:
          type: string
          enum: [ok]
          example: ok
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: 2.0.0
        service:
          type: string
          example: admin-module

    HealthReadyResponse:
      type: object
      required:
        - status
        - timestamp
        - version
        - service
        - checks
      properties:
        status:
          type: string
          enum: [ok, degraded, fail]
          example: ok
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: 2.0.0
        service:
          type: string
          example: admin-module
        checks:
          type: object
          required:
            - postgresql
            - keycloak
          properties:
            postgresql:
              $ref: "#/components/schemas/HealthCheck"
            keycloak:
              $ref: "#/components/schemas/HealthCheck"

    HealthCheck:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [ok, degraded, fail]
          example: ok
        message:
          type: string

    # -----------------------------------------------------------------------
    # Ошибки
    # -----------------------------------------------------------------------

    ErrorResponse:
      type: object
      description: Стандартный формат ошибки (единый для всей системы Artsore)
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: |
                Машиночитаемый код ошибки:
                - `VALIDATION_ERROR` — некорректные входные данные
                - `NOT_FOUND` — ресурс не найден
                - `UNAUTHORIZED` — требуется аутентификация
                - `FORBIDDEN` — недостаточно прав
                - `CONFLICT` — конфликт (дублирующийся ресурс)
                - `SE_UNAVAILABLE` — SE недоступен
                - `IDP_UNAVAILABLE` — Keycloak недоступен
                - `INTERNAL_ERROR` — внутренняя ошибка
              example: NOT_FOUND
            message:
              type: string
              description: Человекочитаемое описание
              example: Ресурс не найден
