<mxfile host="Electron" modified="2026-03-01T09:42:14.731Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/24.5.3 Chrome/124.0.6367.207 Electron/30.0.6 Safari/537.36" version="24.5.3" etag="quT36xN8HVnaglywJMtj" type="device">
  <diagram id="seq-modules" name="GET file by ID — модули">
    <mxGraphModel dx="1220" dy="727" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="700" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="title" value="&lt;b&gt;Поиск файла по ID — взаимодействие модулей&lt;/b&gt;&lt;br&gt;GET /query/api/v1/files/{file_id}" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=15;" parent="1" vertex="1">
          <mxGeometry x="270" y="15" width="440" height="45" as="geometry" />
        </mxCell>
        <mxCell id="a_client" value="&lt;b&gt;Client&lt;/b&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=0;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;size=40;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="80" y="80" width="100" height="570" as="geometry" />
        </mxCell>
        <mxCell id="a_gw" value="&lt;b&gt;API Gateway&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10px&quot;&gt;Envoy&lt;/font&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=0;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;size=40;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="270" y="80" width="100" height="570" as="geometry" />
        </mxCell>
        <mxCell id="a_qm" value="&lt;b&gt;Query Module&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10px&quot;&gt;:8030&lt;/font&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=0;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;size=40;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="490" y="80" width="110" height="570" as="geometry" />
        </mxCell>
        <mxCell id="a_kc" value="&lt;b&gt;Keycloak&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10px&quot;&gt;IdP&lt;/font&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=0;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;size=40;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="700" y="80" width="100" height="570" as="geometry" />
        </mxCell>
        <mxCell id="a_pg" value="&lt;b&gt;PostgreSQL&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10px&quot;&gt;shared DB&lt;/font&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=0;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;size=40;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" parent="1" vertex="1">
          <mxGeometry x="900" y="80" width="100" height="570" as="geometry" />
        </mxCell>
        <mxCell id="note_jwks" value="&lt;i&gt;Фоновый процесс:&lt;br&gt;QM периодически обновляет&lt;br&gt;JWKS-ключи из Keycloak&lt;/i&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;size=14;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="550" y="120" width="190" height="50" as="geometry" />
        </mxCell>
        <mxCell id="msg_jwks" value="GET /.well-known/jwks.json&lt;br&gt;(кэшируется, ~15 сек)" style="html=1;verticalAlign=bottom;endArrow=block;dashed=1;dashPattern=3 3;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=10;fontColor=#999999;strokeColor=#999999;" parent="1" edge="1">
          <mxGeometry x="0.073" y="1" relative="1" as="geometry">
            <mxPoint x="540" y="200.32999999999998" as="sourcePoint" />
            <mxPoint x="745" y="200.32999999999998" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg_jwks_r" value="JWKS keys (RS256)" style="html=1;verticalAlign=bottom;endArrow=open;endFill=0;dashed=1;dashPattern=3 3;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=10;fontColor=#999999;strokeColor=#999999;" parent="1" edge="1">
          <mxGeometry x="0.0732" y="15" relative="1" as="geometry">
            <mxPoint x="745" y="230.32999999999998" as="sourcePoint" />
            <mxPoint x="540" y="230.32999999999998" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="m1" value="&lt;b&gt;1&lt;/b&gt; GET /query/api/v1/files/{file_id}&lt;br&gt;Authorization: Bearer &amp;lt;JWT&amp;gt;" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=11;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="240" as="sourcePoint" />
            <mxPoint x="320" y="240" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="m2" value="&lt;b&gt;2&lt;/b&gt; GET /api/v1/files/{file_id}&lt;br&gt;(route: /query/* → QM, strip prefix)" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=11;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="320" y="290" as="sourcePoint" />
            <mxPoint x="545" y="290" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="m3_self" value="&lt;b&gt;3&lt;/b&gt; Валидация JWT (RS256)&lt;br&gt;Авторизация: role ∈ {admin, readonly}&lt;br&gt;или scope = files:read" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=10;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="545" y="320" as="sourcePoint" />
            <mxPoint x="545" y="380" as="targetPoint" />
            <Array as="points">
              <mxPoint x="590" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="alt" value="" style="shape=mxgraph.sequence.combined_fragment;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=none;strokeColor=#0050ef;dashed=1;dashPattern=5 5;" parent="1" vertex="1">
          <mxGeometry x="500" y="400" width="540" height="170" as="geometry" />
        </mxCell>
        <mxCell id="alt_lbl" value="&lt;b&gt;alt&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=top;fontSize=11;fillColor=#0050ef;fontColor=#ffffff;strokeColor=none;" parent="1" vertex="1">
          <mxGeometry x="500" y="400" width="30" height="18" as="geometry" />
        </mxCell>
        <mxCell id="hit_lbl" value="&lt;b&gt;[cache hit]&lt;/b&gt; — ответ из LRU-кэша (до 10K записей, TTL 5 мин)" style="text;html=1;align=left;verticalAlign=middle;fontSize=10;fontColor=#009900;" parent="1" vertex="1">
          <mxGeometry x="540" y="418" width="380" height="18" as="geometry" />
        </mxCell>
        <mxCell id="hit_note" value="&lt;b&gt;4a&lt;/b&gt; Кэш вернул FileRecord → &lt;i&gt;пропускаем шаг 4b&lt;/i&gt;" style="text;html=1;align=center;verticalAlign=middle;fontSize=10;fontColor=#009900;" parent="1" vertex="1">
          <mxGeometry x="540" y="440" width="360" height="18" as="geometry" />
        </mxCell>
        <mxCell id="alt_div" value="" style="line;strokeWidth=1;dashed=1;dashPattern=5 5;strokeColor=#0050ef;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="470" as="sourcePoint" />
            <mxPoint x="1040" y="470" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="miss_lbl" value="&lt;b&gt;[cache miss]&lt;/b&gt; — запрос в PostgreSQL" style="text;html=1;align=left;verticalAlign=middle;fontSize=10;fontColor=#cc0000;" parent="1" vertex="1">
          <mxGeometry x="540" y="478" width="300" height="18" as="geometry" />
        </mxCell>
        <mxCell id="m4" value="&lt;b&gt;4b&lt;/b&gt; SELECT * FROM file_registry&lt;br&gt;WHERE file_id = $1" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=11;" parent="1" edge="1">
          <mxGeometry x="0.5546" y="5" relative="1" as="geometry">
            <mxPoint x="545" y="515" as="sourcePoint" />
            <mxPoint x="950" y="515" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="m5" value="FileRecord (или 404)" style="html=1;verticalAlign=bottom;endArrow=open;endFill=0;dashed=1;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=11;" parent="1" edge="1">
          <mxGeometry x="-0.5053" y="-10" relative="1" as="geometry">
            <mxPoint x="950" y="550" as="sourcePoint" />
            <mxPoint x="545" y="550" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="m6" value="&lt;b&gt;5&lt;/b&gt; HTTP 200 OK&lt;br&gt;Content-Type: application/json&lt;br&gt;{FileMetadata}" style="html=1;verticalAlign=bottom;endArrow=open;endFill=0;dashed=1;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=11;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="545" y="600" as="sourcePoint" />
            <mxPoint x="320" y="600" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="m7" value="&lt;b&gt;6&lt;/b&gt; HTTP 200 OK {FileMetadata}" style="html=1;verticalAlign=bottom;endArrow=open;endFill=0;dashed=1;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;fontSize=11;fontStyle=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="320" y="635" as="sourcePoint" />
            <mxPoint x="130" y="635" as="targetPoint" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
